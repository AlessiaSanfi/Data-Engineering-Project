name: Olist Pipeline (Phase 2)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # GitHub Actions cron Ã¨ in UTC. Esempio: ogni giorno alle 06:00 UTC
    - cron: "0 2 * * *"

jobs:
  run-phase2:
    runs-on: ubuntu-latest

    env:
      DB_PATH: data/warehouse.duckdb
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Phase 2 pipeline (landing -> bronze -> silver -> gold)
        run: |
          python etl/flows/main_flows_fase2.py

      - name: Smoke check - gold tables exist
        run: |
          python - << 'PY'
          import os, duckdb
          db_path = os.getenv("DB_PATH", "data/warehouse.duckdb")
          con = duckdb.connect(db_path, read_only=True)

          required = [("gold","fact_sales"),("gold","dim_products"),("gold","dim_customers"),("gold","dim_time")]
          missing = []
          for s,t in required:
            ok = con.execute("""
              SELECT 1
              FROM information_schema.tables
              WHERE table_schema=? AND table_name=?
              LIMIT 1
            """,[s,t]).fetchone()
            if not ok:
              missing.append(f"{s}.{t}")
          if missing:
            con.close()
            raise SystemExit(f"Missing gold tables: {missing}")

          print("OK: gold tables present")
          con.close()
          PY

      - name: Print row counts (bronze/silver/gold)
        run: |
          python - << 'PY'
          import os, duckdb

          db_path = os.getenv("DB_PATH", "data/warehouse.duckdb")
          con = duckdb.connect(db_path, read_only=True)

          checks = [
              ("bronze.orders", "SELECT COUNT(*) FROM bronze.orders"),
              ("bronze.order_items", "SELECT COUNT(*) FROM bronze.order_items"),
              ("silver.orders", "SELECT COUNT(*) FROM silver.orders"),
              ("silver.order_items", "SELECT COUNT(*) FROM silver.order_items"),
              ("gold.fact_sales", "SELECT COUNT(*) FROM gold.fact_sales"),
              ("gold.dim_time", "SELECT COUNT(*) FROM gold.dim_time"),
          ]

          print("=== Row counts ===")
          for label, q in checks:
              try:
                  n = con.execute(q).fetchone()[0]
                  print(f"{label}: {n}")
              except Exception as e:
                  print(f"{label}: ERROR ({e})")

          con.close()
          PY

      - name: Upload DuckDB warehouse as artifact
        uses: actions/upload-artifact@v4
        with:
          name: warehouse-duckdb
          path: data/warehouse.duckdb
